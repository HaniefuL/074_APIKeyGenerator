<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Generate API Key</title>
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" />
        <style>
            :root {
                --card-radius: 14px;
                --accent: #4f46e5;
            }

            html, body {
                height: 100%;
            }

            body {
                background: linear-gradient(180deg, #eef2ff 0%, #f8fafc 100%);
                font-family: system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial;
                display: flex;
                align-items: center;
                justify-content: center;
                padding: 24px;
            }

            .card-app {
                width: 100%;
                max-width: 640px;
                border-radius: var(--card-radius);
                box-shadow: 0 10px 30px rgba(15, 23, 42, 0.08);
                overflow: hidden;
            }

            .card-hero {
                background: linear-gradient(90deg, rgba(79,70,229,0.95), rgba(99,102,241,0.95));
                color: white;
                padding: 20px 24px;
            }

            .brand {
                display: flex;
                gap: 12px;
                align-items: center;
            }

            .brand svg { width: 36px; height: 36px; }

            .form-section { padding: 20px 24px; background: white; }

            .btn-copy { min-width: 48px; }

            #msgBox { display: none; }
        </style>
    </head>
    <body>

        <div class="card card-app">
            <div class="card-hero d-flex align-items-center justify-content-between">
                <div class="brand">
                    <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <rect width="24" height="24" rx="6" fill="white" opacity="0.06" />
                        <path d="M7 12h10" stroke="white" stroke-width="1.5" stroke-linecap="round"/>
                        <path d="M7 8h10" stroke="white" stroke-width="1.5" stroke-linecap="round" opacity="0.6"/>
                    </svg>
                    <div>
                        <div style="font-weight:600">API Key Generator</div>
                        <small style="opacity:0.9">Generate & save keys for users</small>
                    </div>
                </div>
                <div class="text-end">
                    <small>Made for Praktikum</small>
                </div>
            </div>

            <div class="form-section">
                <div class="mb-3">
                    <label class="form-label">Nama Depan</label>
                    <input id="first" class="form-control" placeholder="Nama Depan" required />
                </div>

                <div class="mb-3">
                    <label class="form-label">Nama Belakang</label>
                    <input id="last" class="form-control" placeholder="Nama Belakang" />
                </div>

                <div class="mb-3">
                    <label class="form-label">Email</label>
                    <input id="email" class="form-control" placeholder="example@mail.com" type="email" required />
                </div>

                <div class="mb-3">
                    <label class="form-label">API Key</label>
                    <div class="input-group">
                        <input id="apikey" class="form-control" readonly placeholder="Klik Generate untuk membuat API Key" />
                        <button id="btnCopy" class="btn btn-outline-secondary btn-copy" type="button" onclick="copyKey()">Copy</button>
                    </div>
                </div>

                <div class="d-grid gap-2 d-md-flex">
                    <button id="btnGen" onclick="genKey()" class="btn btn-outline-primary me-md-2">Generate API Key</button>
                    <button id="btnSave" onclick="saveDB()" class="btn btn-primary">Save to Database</button>
                </div>

                <div class="mt-3">
                    <a href="/admin.html">Admin Login</a>
                </div>

                <div id="msgBox" class="alert mt-3" role="alert"></div>
            </div>
        </div>

        <script>
            function showMessage(text, type = 'success') {
                const box = document.getElementById('msgBox');
                box.className = 'alert mt-3 alert-' + type;
                box.innerText = text;
                box.style.display = 'block';
                setTimeout(() => { box.style.display = 'none'; }, 4500);
            }

            function genKey() {
                const key = 'API-' + Math.random().toString(36).substring(2, 10).toUpperCase() + '-' + Date.now();
                document.getElementById('apikey').value = key;
                showMessage('API Key generated.', 'success');
            }

            function copyKey() {
                const k = document.getElementById('apikey').value;
                if (!k) return showMessage('Tidak ada API Key untuk disalin.', 'warning');
                navigator.clipboard?.writeText(k).then(() => {
                    showMessage('API Key disalin ke clipboard.', 'success');
                }).catch(() => {
                    showMessage('Gagal menyalin. Silakan salin manual.', 'danger');
                });
            }

            async function saveDB() {
                const firstName = document.getElementById('first').value.trim();
                const lastName = document.getElementById('last').value.trim();
                const email = document.getElementById('email').value.trim();
                const apikey = document.getElementById('apikey').value.trim();
                const btn = document.getElementById('btnSave');

                if (!firstName || !email) {
                    return showMessage('Nama Depan dan Email wajib diisi.', 'warning');
                }
                if (!apikey) {
                    return showMessage('Generate API Key terlebih dahulu.', 'warning');
                }

                btn.disabled = true;
                btn.innerText = 'Saving...';

                const data = { first_name: firstName, last_name: lastName, email: email, apikey: apikey };

                try {
                    const res = await fetch('/users/create', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });

                    const response = await res.json();

                    if (response.error) {
                        showMessage('Gagal menyimpan: ' + response.msg, 'danger');
                    } else {
                        showMessage('API Key berhasil disimpan!', 'success');
                        document.getElementById('first').value = '';
                        document.getElementById('last').value = '';
                        document.getElementById('email').value = '';
                        document.getElementById('apikey').value = '';
                    }
                } catch (e) {
                    showMessage('Server error / tidak bisa terhubung.', 'danger');
                }

                btn.disabled = false;
                btn.innerText = 'Save to Database';
            }
        </script>
    </body>
</html>
